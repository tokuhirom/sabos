# メモリ管理の方針（設計）

SABOS のメモリ管理を「今すぐやる分」と「今後の発展」の2段階で整理する。
POSIX 互換は目指さないため、**型安全・capability・明確な境界**を最優先にする。

---

## 目的

- **ユーザー空間とカーネル空間の境界を壊さない**
- **物理フレームのライフサイクルを追跡可能にする**
- **ページテーブル操作の責務を一本化する**
- **「どの CR3 で何を書くか」を明文化する**

---

## 1. 今すぐやる分（必須）

### 1.1 基本ルール（破るとバグ）

- **ELF ロード時の書き込みは必ずカーネル CR3 で行う**
  - 物理フレームへ memcpy するため、ユーザーページテーブルでの書き込みは禁止
- **UserPtr/UserSlice の検証は syscall 入口で完了させる**
  - カーネル内部の関数では「検証済み前提」にする
- **ユーザーページテーブルの変更は `map_user_pages_in_process()` に統一する**
  - 例外は作らない

### 1.2 ライフサイクルの責務

- **フレームの確保と解放は常に同じ層で完結する**
  - `create_elf_process()` が確保したフレームは `destroy_user_process()` が解放
- **中間ページテーブルの分岐コピーは `destroy_process_page_table()` が回収**

### 1.3 可視化（最小）

- **procfs でフレーム統計を出す（JSON）**
  - 例: total/free/used、プロセスごとの使用量（ざっくりでOK）
- **selftest に簡単なメモリ整合性チェックを追加**
  - 例: “allocate → map → unmap → free” の流れが破綻しない

---

## 2. 近い将来にやる分（設計ラフ）

### 2.1 アドレス空間の明確化

- **ユーザー空間レイアウトを固定化**
  - code/data/bss/heap/stack の順序と境界を明確化
- **ヒープとスタックの衝突検出**
  - 低コストで「これ以上は危険」を検出する仕組みを作る

### 2.2 フレーム追跡の強化

- **フレームに所有者タグを持たせる（デバッグ用途）**
  - 例: pid / 用途 (code/data/stack/heap/page_table)
- **二重解放・二重割当の検出**
  - panic ではなく “検知ログ + 自己防御” を優先

### 2.3 ページフォルトの扱い

- **ユーザーモード PF のエラー分類を整理**
  - null / 範囲外 / 権限 / 未マップ の区別をログで見えるように
- **クラッシュ時の最小ダンプ**
  - RIP/RSP/CR2/タスク名/直近 syscall 番号

---

## 3. さらに先の発展（設計ラフ）

### 3.1 ガードページ

- スタック末尾に guard page を入れる
- 破壊を早期検知する（即時 PF で止まる）

### 3.2 ユーザー空間アロケータの分離

- 「小さいヒープ（通常プロセス）」と「大きいヒープ（GUI等）」を標準化
- できれば capability で「使えるヒープサイズ」を制限

### 3.3 アドレス空間の監査 API

- “このハンドルが指すメモリ範囲を表示” できるデバッグ API
- 仕様は procfs JSON でよい（人間が読めればOK）

---

## 運用ルール

- 仕様変更が入ったら **必ずこのドキュメントを更新**
- syscall の追加・変更があれば `docs/spec/syscall-list.md` も更新
- procfs の JSON 仕様は `docs/spec/procfs-json.md` に合わせる
