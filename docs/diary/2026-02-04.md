# 2026-02-04: Day 4 — IPC 型安全プロトタイプと syscall 一覧

## 今日の計画: IPC の型安全メッセージパッシング（プロトタイプ）

### 実装計画（変更ファイル・変更内容）

1. `kernel/src/ipc.rs` — Typed IPC の送受信キューを追加し、型の一致を強制する send/recv を実装
2. `kernel/src/shell.rs` — selftest に typed IPC のテストを追加

### 実装内容

- `kernel/src/ipc.rs` に Typed IPC を追加。タスクごとに 1 種類の型だけを受け付けるキューを持たせ、型が一致しない送受信はエラーにした
- `kernel/src/shell.rs` の selftest に `ipc_typed` を追加し、同一タスク間で構造体を送受信できることを確認した

### 学んだこと

- **TypeId**: Rust が型ごとに持つ一意の識別子。実行時に「このキューが受け付ける型は何か」をチェックするのに使える

---

## 今日の計画: システムコール一覧ドキュメント作成

### 実装計画（変更ファイル・変更内容）

1. `docs/spec/syscall-list.md` を新規作成し、番号・引数・戻り値を一覧化する
2. `AGENTS.md` に「いつ更新が必要か」のルールを追加する

### 実装内容

- `docs/spec/syscall-list.md` を作成し、システムコール番号・引数・戻り値を一覧化した
- `AGENTS.md` に「追加/削除/引数変更/戻り値変更時に一覧を更新する」ルールを追記した

### 学んだこと

- **インターフェースの一貫性**: システムコールは OS とユーザー空間の境界仕様なので、一覧が最新でないと仕様破綻に直結する

---

## 今日の計画: GUI 依存の ls 確認を自動テスト化

### 実装計画（変更ファイル・変更内容）

1. `scripts/run-selftest.sh` — user シェルで `ls` を実行し、結果を検証するステップを追加

### 実装内容

- user シェルの `ls` を QEMU monitor 経由で実行し、`HELLO.TXT` が出ることを確認してから selftest に進むようにした

### 学んだこと

- **再現性**: 人手での GUI 操作に依存すると CI で検証できないので、QEMU monitor の sendkey を使って自動化するのが効果的

---

## 今日の計画: ユーザー空間のブロック I/O を安全にする

### 実装計画（変更ファイル・変更内容）

1. `kernel/src/syscall.rs` — `SYS_BLOCK_READ/WRITE` でカーネルバッファを介して DMA する

### 実装内容

- `sys_block_read()` で一旦カーネル側の 512B バッファに読み取り、ユーザー空間へコピーするように変更
- `sys_block_write()` もユーザー空間のバッファをカーネル側にコピーしてから書き込むように変更

### 学んだこと

- **DMA と仮想アドレス**: デバイスは物理アドレスを使うため、ユーザー空間の仮想アドレスを直接渡すと壊れる。カーネル側でバッファを用意してコピーするのが安全
