# SABOS 夢いっぱい TODO リスト 🚀✨

セキュリティと型安全性を重視した、夢の自作 OS への道のり。

## 🎯 短期目標（そろそろやりたい）

### IPC 基盤
- [ ] 型安全 IPC の実運用化
  - ユーザー空間 API へ公開（安全な型の受け渡し）
  - タイムアウト/キャンセル/優先度の設計
  - IPC 経由の Capability 委譲の実装

### Capability ベースの実装を日常運用に
- [ ] ユーザーシェルをハンドル API に移行
  - パスベース API を最小限に縮小
  - openat + restrict_rights でサンドボックス化
- [ ] すべてのファイル操作を VFS 経由に統一
  - procfs も VFS の子として扱う
  - JSON 出力の統一

### ファイルシステムのユーザー空間移行
- [ ] FAT16 ドライバをユーザー空間で動かす（サービス化）
- [ ] VFS (Virtual File System) 層の設計
- [ ] ファイルシステムがクラッシュしてもカーネルは生き残る
- [ ] procfs をユーザー空間サービス化

### ネットワークスタックのユーザー空間移行
- [ ] TCP/IP スタックをユーザー空間サービス化
- [ ] ネットワークドライバの分離
- [ ] バグがあってもカーネルパニックしない

### テストと再現性
- [ ] selftest にユーザー空間サービスの健全性チェックを追加
- [ ] CI で “人間操作ゼロ” の完全自動検証へ

## 🌟 中期目標（いつかやりたい）

### セキュリティ強化
- [ ] ASLR (Address Space Layout Randomization)
  - プロセスのメモリ配置をランダム化
  - 攻撃者がアドレスを推測できなくする
- [ ] W^X (Write XOR Execute)
  - メモリページは「書き込み可能」か「実行可能」のどちらか一方のみ
  - コード注入攻撃を防ぐ
- [ ] スタックカナリア
  - バッファオーバーフローを検出
- [ ] KASLR (Kernel ASLR)
  - カーネル自体のアドレスもランダム化

### Capability ベース OS への進化
- [ ] 全リソースを Capability で管理
  - ファイル、ネットワーク、デバイス、メモリ全てが権限トークン
  - 「何でもできる root」を廃止
- [ ] 最小権限の原則を強制
  - プロセスは必要な権限だけを持つ
  - 権限エスカレーション攻撃を構造的に防ぐ
- [ ] Capability の型安全な受け渡し
  - IPC で権限を安全に委譲

### 形式検証への挑戦
- [ ] カーネルの重要部分を Kani/Prusti で検証
  - メモリ管理の安全性
  - スケジューラの公平性
  - IPC のデッドロックフリー
- [ ] 契約プログラミング
  - 事前条件・事後条件・不変条件を明示

### メモリアロケータ本格化ロードマップ

現状: カーネルもユーザーも `linked_list_allocator` crate に依存、固定サイズヒープ。
目標: 本格的な OS レベルのメモリ管理（バディ + スラブ + 動的ヒープ）。

**Phase 1: 足元の改善**
- [x] 1a. フレームアロケータの二重解放をパニックに変更
- [x] 1b. ユーザー空間 OOM ハンドラの改善（エラー表示 + exit）
- [x] 1c. フレームアロケータのリージョン探索を二分探索に高速化

**Phase 2: バディアロケータ（物理フレーム層）**
- [x] 連続フレーム確保のためバディアロケータを実装
  - order 0〜10（4 KiB〜4 MiB）
  - 分割・合体（split/coalesce）機構
  - 既存のビットマップアロケータを置き換え

**Phase 3: スラブアロケータ（カーネルヒープ層）**
- [x] サイズクラス別メモリプールを自作
  - 32, 64, 128, 256, 512, 1024, 2048 バイト
  - alloc/dealloc O(1)
  - `linked_list_allocator` crate 依存を除去

**Phase 4: ユーザー空間の動的メモリ（syscall 層）**
- [ ] 4a. sys_sbrk 相当のシステムコール
  - プロセスごとの heap_start/heap_end 管理
  - BSS 固定ヒープからの脱却
- [ ] 4b. sys_mmap 相当のシステムコール
  - 匿名メモリマッピング
  - 共有メモリの基盤
- [ ] 4c. VMA (Virtual Memory Area) 管理
  - プロセスのアドレス空間を VMA リストで管理

**Phase 5: 発展的機能**
- [ ] Demand Paging（ページを必要になるまで確保しない）
- [ ] メモリマップドファイル (mmap)
- [ ] Huge Pages サポート（2MB/1GB ページで TLB ミスを削減）
- [ ] OOM Killer（メモリ不足時のプロセス選択終了）

### プロセス管理の洗練
- [ ] wait() が終了タスク ID も返せるようにする
- [ ] 子プロセスのライフサイクル管理 API（kill/terminate）
- [ ] サービス監視のポリシー（再起動回数/バックオフ）

### Fork-less 設計（設計方針）
SABOS は意図的に fork() を提供しない:
- **spawn ベースのプロセス生成**: 新プロセスは白紙状態から始まる
- **明示的な権限委譲**: 親から子への Capability は明示的に渡す
- **セキュリティ**: 親の状態が暗黙的に漏れない
- **シンプル**: CoW の複雑さを回避

## 🌈 長期目標（夢）

### GUI サブシステム
- [ ] フレームバッファベースのウィンドウシステム
- [ ] 最小限のウィンドウマネージャ
- [ ] マウスドライバ（USB HID または PS/2）
- [ ] 簡単な GUI ツールキット
- [ ] ターミナルエミュレータ
- [ ] 画像ビューア
- [ ] 起動後に “最初の一枚絵” を表示（Welcome 画面）

### ネットワーク機能拡張
- [ ] DHCP クライアント
  - IP アドレスの自動取得
- [ ] HTTPS (TLS 1.3)
  - 暗号化通信
  - 証明書検証
- [ ] SSH サーバー/クライアント
  - セキュアなリモートアクセス
- [ ] NTP クライアント
  - 時刻同期

### ファイルシステム拡張
- [ ] ext2/ext4 サポート
- [ ] ジャーナリング
  - クラッシュ時のデータ保護
- [ ] 暗号化ファイルシステム
  - ディスク全体を暗号化
- [ ] FUSE 的なユーザー空間 FS インターフェース

### ハードウェアサポート拡張
- [ ] AHCI (SATA) ドライバ
  - 実機の SSD/HDD にアクセス
- [ ] NVMe ドライバ
  - 高速 SSD
- [ ] USB 3.0 (xHCI)
  - キーボード、マウス、ストレージ
- [ ] Intel HD Audio
  - 音を鳴らす！
- [ ] GPU ドライバ（基本的な 2D アクセラレーション）

### マルチコア対応
- [ ] SMP (Symmetric Multi-Processing)
  - 複数 CPU コアを活用
- [ ] Per-CPU データ構造
- [ ] ロックフリーデータ構造
- [ ] コア間 IPI (Inter-Processor Interrupt)

### セルフホスティング
- [ ] SABOS 上で Rust コンパイラを動かす
- [ ] SABOS 上で SABOS をビルドする
- [ ] 自分自身をコンパイルできる OS になる！

## 🎮 お楽しみ機能

### ゲーム
- [ ] テトリス
- [ ] スネークゲーム
- [ ] Doom（移植）
- [ ] シンプルな 2D ゲームエンジン

### デモ
- [ ] 起動時のアニメーション
- [ ] アスキーアート表示
- [ ] 3D ワイヤーフレーム回転（ソフトウェアレンダリング）

### 開発者ツール
- [ ] カーネルデバッガ
- [ ] システムモニター（top 的なもの）
- [ ] ファイルマネージャ
- [ ] テキストエディタ（ed/vi 的なもの）
- [ ] “実行中サービス一覧” の可視化ダッシュボード

## 🔬 研究的な挑戦

### 言語統合
- [ ] カーネルとユーザー空間で同じ型定義を共有
- [ ] システムコールの型を自動生成
- [ ] コンパイル時に権限チェック

### 新しいセキュリティモデル
- [ ] 情報フロー制御
  - 機密データがどこに流れるか追跡
- [ ] サンドボックス
  - 信頼できないコードを隔離実行
- [ ] Secure Enclave 的な機能
  - 機密処理を分離

### 分散システム
- [ ] 複数マシンでの透過的なプロセス移動
- [ ] 分散ファイルシステム
- [ ] クラスタ上での並列計算

---

## 📝 完了した項目

- [x] UEFI ブート
- [x] フレームバッファ描画
- [x] キーボード入力
- [x] ページング・仮想メモリ
- [x] ヒープアロケータ
- [x] 協調的マルチタスク
- [x] プリエンプティブマルチタスク
- [x] ユーザーモード (Ring 3)
- [x] プロセス分離（独立アドレス空間）
- [x] ELF ローダー
- [x] virtio-blk ドライバ
- [x] FAT16 ファイルシステム（読み書き）
- [x] virtio-net ドライバ
- [x] ARP / ICMP
- [x] UDP / DNS クライアント
- [x] TCP クライアント / HTTP GET
- [x] ユーザー空間シェル（17 コマンド）
- [x] 型安全なシステムコール境界 (UserSlice<T>)
- [x] 自動テストフレームワーク (selftest)
- [x] 型安全 IPC（TypeId による型一致保証）
- [x] Capability ベースの VFS / ハンドル API (open/openat/restrict_rights)
- [x] init / supervisor（ユーザー空間サービス管理）
- [x] SYS_WAIT / SYS_GETPID でのプロセス制御基盤
- [x] CI での自動操作（sendkey による再現テスト）

---

*「完璧を目指すより、まず動くものを作る。動いたら少しずつ良くする。」*

*楽しんで作ろう！* 🎉
